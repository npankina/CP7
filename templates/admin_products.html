{% extends 'base.html' %}

{% block title %}Админ Панель - Товары{% endblock %}

{% block content %}
<div class="main-container">
    <h1>Товары</h1>

    <!-- Кнопка для вызова модального окна добавления нового товара -->
    <button id="add-product-btn" class="add-product-btn">Добавить новый товар</button>


    <!-- Таблица товаров -->
    <div class="table-container ">
        <table>
            <tr>
                <th>ID</th>
                <th>Изображение</th>
                <th>Название</th>
                <th>Коллеция</th>
                <th>Описание</th>
                <th>Цена</th>
                <th>В наличии</th>
                <th>Действия</th>
            </tr>
            {% for product in products %}
            <tr>
                <td>{{ product.id }}</td>
                <td>
                    <img src="{{ url_for('static', filename=product.image) }}" alt="{{ product.image }}"  width="150">
                </td>
                <td>{{ product.name }}</td>
                <td>{{ product.category }}</td>
                <td>{{ product.description }}</td>
                <td>{{ product.price }} руб.</td>
                <td>{{ product.stock }}</td>
                <td>
                    <div class="action-buttons">
                        <!-- Кнопка редактирования -->
                        <button class="edit-product-btn"
                                data-id="{{ product.id }}"
                                data-name="{{ product.name }}"
                                data-category="{{ product.category }}"
                                data-description="{{ product.description }}"
                                data-price="{{ product.price }}"
                                data-stock="{{ product.stock }}"
                                data-image="{{ product.image }}">Редактировать</button>
                        <!-- Кнопка дублирования карточки товара -->
                        <button class="duplicate-btn" data-id="{{ product.id }}">Дублировать</button>
                        <!-- Кнопка редактирования карточки товара -->
                        <button class="delete-btn" data-id="{{ product.id }}">Удалить</button>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </table>
    </div>
</div>


 <!-- Модальное окно для редактирования товара -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <span class="close-btn">&times;</span>
            <h2>Редактировать товар</h2>
            <form id="edit-product-form" action="#" method="POST" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="edit-id" name="id">

                <label for="edit-name">Название:</label>
                <input type="text" id="edit-name" name="product_name" required>

                <label for="edit-category">Категория:</label>
                <input type="text" id="edit-category" name="category" required>

                <label for="edit-description">Описание:</label>
                <textarea id="edit-description" name="description" required></textarea>

                <label for="edit-price">Цена:</label>
                <input type="number" id="edit-price" name="price" required>

                <label for="edit-stock">В наличии:</label>
                <input type="number" id="edit-stock" name="stock" required>

                <label for="edit-image">Изображение:</label>
                <input type="file" id="edit-image" name="image" accept="image/*">

                <button type="submit" class="submit-btn">Сохранить</button>
            </form>
        </div>
    </div>




{% endblock %}

{% block scripts %}
<script>
    // Обработчик дублирования товара
    document.querySelectorAll('.duplicate-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            fetch(`/admin/products/duplicate/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Ошибка при дублировании товара.');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Товар успешно добавлен (дублирован).');
                    location.reload();
                } else {
                    alert(data.message || 'Ошибка при дублировании товара');
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert('Произошла ошибка при выполнении запроса');
            });
        });
    });

    // Обработчик удаления товара
    document.querySelectorAll('.delete-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');
            fetch(`/admin/products/delete/${productId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.message || 'Ошибка при удалении товара.');
                    });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Товар успешно помечен как удаленный.');
                    location.reload();
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert(error.message || 'Произошла ошибка при выполнении запроса.');
            });
        });
    });

    // Обработчик редактирования товара
    document.querySelectorAll('.edit-product-btn').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-id');

            // Заполнение формы данными товара
            document.getElementById('edit-id').value = productId;
            document.getElementById('edit-name').value = this.getAttribute('data-name');
            document.getElementById('edit-category').value = this.getAttribute('data-category');
            document.getElementById('edit-description').value = this.getAttribute('data-description');
            document.getElementById('edit-price').value = this.getAttribute('data-price');
            document.getElementById('edit-stock').value = this.getAttribute('data-stock');

            // Открытие модального окна
            const modal = document.getElementById('edit-product-modal');
            modal.style.display = 'block';

            // Обработчик отправки формы
            const editForm = document.getElementById('edit-product-form');

            editForm.onsubmit = function(event) {
                event.preventDefault(); // Предотвращаем стандартное поведение формы

            const formData = new FormData(editForm); // Собираем данные из формы

            fetch(`/admin/products/edit/${document.getElementById('edit-id').value}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value // Убедитесь, что это правильный токен
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Ошибка при редактировании товара.');
                        });
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    alert('Товар успешно отредактирован.');
                    location.reload(); // Перезагружаем страницу
                }
            })
            .catch(error => {
                console.error('Ошибка:', error);
                alert(error.message || 'Произошла ошибка при выполнении запроса.');
            });
        };
    });
            

    // Закрытие модального окна
    document.querySelector('.close-btn').addEventListener('click', function() {
        const modal = document.getElementById('edit-product-modal');
        modal.style.display = 'none'; // Скрыть модальное окно
    });


    // Обработчик добавления нового товара
    
    
</script>
{% endblock %}
